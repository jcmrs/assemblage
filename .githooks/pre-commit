#!/bin/bash
#
# üöß Guardrail: pre-commit
#
# (Version 1.3.0 - Assemblage "Bifurcated Ownership" Model)
#
# This is the primary "Guardrail" of the "Assemblage."
# It is a "dumb enforcer" that "Nudges" the System Owner (AI)
# by calling smart "Utilities" to validate work *before* it is
# committed to "Process Memory" (Git).
#
# This Guardrail enforces two "How" (Platform) checks:
# 1. LINT CHECK: Are the "house" files (`.sh`, `.yml`) syntactically valid?
# 2. WORKSPACE CHECK: Is the current "Workbench" (Builder, Architect)
#    respecting its "clean separation" boundaries?
#
#=======================================================================

set -e

# --- Colors for AI Readability ---
BLUE="\033[0;34m"
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[1;33m"
CYAN="\033[0;36m"
NC="\033[0m" # No Color

# --- Helper Functions ---
function log() {
    echo -e "${GREEN}[GUARDRAIL] $1${NC}"
}
function error() {
    echo -e "${RED}[FAIL] $1${NC}" >&2
}
function info() {
    echo -e "${BLUE}[INFO] $1${NC}"
}
function section() {
    echo -e "\n${CYAN}--- $1 ---${NC}"
}

# --- Main Logic ---
log "Running 'pre-commit' Guardrail (v1.3.0)..."
OVERALL_PASSED=true

# ====================================================================
# CHECK 1: LINT CHECK (Code Quality)
#
# Run the "lint" Utility to check for "wobbly" .sh or .yml code.
# ====================================================================
section "CHECK 1: Running 'lint' Utility"
LINT_UTILITY="tools/lint.sh"

if [ ! -f "$LINT_UTILITY" ]; then
    error "Lint Utility ('$LINT_UTILITY') not found!"
    echo -e "${YELLOW}Cannot validate code quality. This is a 'How' (Platform) failure.${NC}"
    OVERALL_PASSED=false
else
    if ! ./"$LINT_UTILITY"; then
        error "Lint Check FAILED. See errors above."
        OVERALL_PASSED=false
    else
        log "Lint Check PASSED. 'House' files are clean."
    fi
fi

# ====================================================================
# CHECK 2: WORKSPACE BOUNDARY CHECK
#
# Run the "validate-workspace" Utility to enforce "clean separation."
# This script reads "config/workbenches.yml" to find the rules.
# ====================================================================
section "CHECK 2: Running 'validate-workspace' Utility"
WORKSPACE_UTILITY="tools/validate-workspace.sh"

if [ ! -f "$WORKSPACE_UTILITY" ]; then
    error "Workspace Utility ('$WORKSPACE_UTILITY') not found!"
    echo -e "${YELLOW}Cannot validate 'clean separation'. This is a 'How' (Platform) failure.${NC}"
    echo -e "${YELLOW}(As System Owner, you must create this 'Utility'.)"
    OVERALL_PASSED=false
else
    # Get all staged files (added, copied, modified)
    STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

    if [ -z "$STAGED_FILES" ]; then
        log "No files staged for commit. Skipping workspace check."
    else
        info "Checking workspace boundaries for staged files..."
        # Pass all staged files to the utility
        if ! ./"$WORKSPACE_UTILITY" $STAGED_FILES; then
            error "Workspace Boundary Check FAILED. See errors above."
            echo -e "${YELLOW}A 'Workbench' is trying to modify files outside its 'guardrail_workspace' rules.${NC}"
            OVERALL_PASSED=false
        else
            log "Workspace Boundary Check PASSED. 'Clean separation' is intact."
        fi
    fi
fi

# ====================================================================
# FINAL RESULT
# ====================================================================
if [ "$OVERALL_PASSED" = true ]; then
    log "------------------------------------------------------"
    log "‚úÖ Pre-Commit Guardrail PASSED."
    log "All checks clear. Proceeding with commit."
    exit 0 # Return success code
else
    error "------------------------------------------------------"
    error "‚ùå Pre-Commit Guardrail FAILED."
    error "One or more 'house' integrity checks failed."
    error "As System Owner, you MUST fix these errors before committing."
    echo -e "${YELLOW}To override (NOT RECOMMENDED): git commit --no-verify${NC}"
    exit 1 # Return failure code
fi
