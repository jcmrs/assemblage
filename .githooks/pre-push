#!/bin/bash
#
# üöß Guardrail: pre-push
#
# (Version 1.5.0 - Adopting "as-is" from perplex repository)
#
# This is a "House Service" Guardrail.
#
# PURPOSE:
# This script enforces our "Branching Strategy" to protect
# our "Process Memory" (the Git history).
#
# It performs one critical check:
# 1. BLOCK PUSHES TO `main`: It prevents *any* direct push
#    to the `main` branch.
#
# This Guardrail *forces* all work to go through our automated
# PR "conveyor belt," which is a core "How" (Platform)
# component of our AI-First Assemblage.
#
#=======================================================================

# --- Colors for AI Readability ---
RED="\033[0;31m"
YELLOW="\033[1;33m"
GREEN="\033[0;32m"
NC="\033[0m" # No Color

# --- Main Logic ---

# Read the remote name and URL from Git's parameters
remote_name="$1"
remote_url="$2"

while read local_ref local_sha remote_ref remote_sha; do
    
    # Check if the remote branch is 'main'
    if [[ "$remote_ref" == "refs/heads/main" ]]; then
        echo -e "${RED}===================================================================${NC}"
        echo -e "${RED}‚ùå GUARDRAIL: DIRECT PUSH TO 'main' IS PROHIBITED!${NC}"
        echo -e "${RED}===================================================================${NC}"
        echo -e "${YELLOW}This Assemblage enforces a strict 'AI-First' automation policy.${NC}"
        echo -e "${YELLOW}All code MUST be submitted via a Pull Request (PR)."
        echo ""
        echo -e "${GREEN}As the System Owner (AI), your 'Nudge' is:${NC}"
        echo -e "${GREEN}  1. Push this branch under a different name (e.g., 'claude/my-feature').${NC}"
        echo -e "${GREEN}  2. Our 'Assemblage' automation (.github/workflows/) will${NC}"
        echo -e "${GREEN}     automatically create and merge the PR for you.${NC}"
        echo ""
        echo -e "${YELLOW}To override (NOT RECOMMENDED): git push --no-verify${NC}"
        echo -e "${RED}===================================================================${NC}"
        
        # Exit with a non-zero status to block the push
        exit 1
    fi
done

# All branches are fine, allow the push
exit 0
